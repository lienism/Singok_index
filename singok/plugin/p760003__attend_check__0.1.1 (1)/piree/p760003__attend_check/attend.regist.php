<?php

/*
===========================================================

	프로젝트 이름 : Piree WON Program

	만든사람 : 피리

	홈페이지 : http://www.piree.co.kr

	작성날짜 : 2014년 01월 23일 목요일 오후 14시 17분 - 날씨 맑고 기온 올랐음

	저 작 권 : Copyright ⓒ 2014 투스포츠 (원병철) All right reserved
							그누보드 외에 추가된 소스는~
							만든사람의 허락없이 무단으로 사용할수 없습니다.
							사용하고자 할 경우 만든사람의 허락을 받아야 합니다.
							http://www.piree.co.kr 에 문의해 주세요.

===========================================================
 피리 > 피리 출석체크 FREE G5 > 출석체크 하기
===========================================================


*/


	#########################################################
	# 시작 => 라이브러리__화일__첨부
	#########################################################

	//=======================================================
	// 라이브러리__첨부
	include_once ('./_common.php');


	//=======================================================
	// 시작 => 회원_여부__확인
	IF ($is_guest || !$is_member)
	{
		alert ("회원만 이용하실 수 있습니다", G5_DOMAIN."/");
		EXIT;
	}
	// 끝 => 회원_여부__확인
	//=======================================================

	#########################################################
	# 끝 => 라이브러리__화일__첨부
	#########################################################



	#########################################################
	# 시작 => 레벨__설정_정보_화일__첨부
	#########################################################

	//=======================================================
	// 피리_메뉴__번호
	$piree_menu_n = 760003;


	//=======================================================
	// 기본_설정_첨부__여부
	// 0 - 안해
	$is_get__piree_config = 0;


	//=======================================================
	// 출석체크__설정_정보__가져오기
	$is_get__attend_config = 1;


	//=======================================================
	// 레벨__설정_정보_화일__경로
	$piree_dir_path = "../_config/p__".$piree_menu_n."/pi__config.php";


	//=======================================================
	// 레벨__설정_정보_화일__경로
	include_once ($piree_dir_path);

	#########################################################
	# 끝 => 레벨__설정_정보_화일__첨부
	#########################################################



	#########################################################
	# 시작 => 출석_가능__여부__확인
	#########################################################

	//=======================================================
	// 출석_가능__여부
	// 0 - 불가
	// 1 - 가능
	$is_use__attend = chk__attend_time();


	//=======================================================
	// 시작 => 출석_시간__아니면
	IF ($is_use__attend != 1)
	{
		alert ("지금은 출석시간이 아닙니다. 출석시간에 시도해 주세요.", $go_url_s);	
		EXIT;
	}
	// 끝 => 출석_시간__아니면
	//=======================================================

	#########################################################
	# 끝 => 출석_가능__여부__확인
	#########################################################



	#########################################################
	# 시작 => 상수__변수
	#########################################################

	//=======================================================
	// 이동할_페이지
	$go_url_s = $attend_config["prog_u"];

	#########################################################
	# 끝 => 상수__변수
	#########################################################



	#########################################################
	# 시작 => QUERY_STRING__검증
	#########################################################

	//=======================================================
	// QUERY_STRING
	$cont_s = $_POST["cont_s"];


	//=======================================================
	// 태그_제거
	$cont_s = strip_tags($cont_s);


	//=======================================================
	// 시작 => 한마디__없으면
	IF (!$cont_s || $cont_s == "")
	{
		alert ("한마디를 입력해 주세요.", $go_url_s);	
		EXIT;
	}
	// 끝 => 한마디__없으면
	//=======================================================


	//=======================================================
	// 시작 => 한마디_글자_Byte__적으면
	/*
	IF (strlen($cont_s) < 15)
	{
		alert ("한마디를 글자를 15Byte 이상으로 입력해 주세요.", $go_url_s);	
		EXIT;
	}
	*/
	// 끝 => 한마디_글자_Byte__적으면
	//=======================================================

	#########################################################
	# 끝 => QUERY_STRING__검증
	#########################################################



	#########################################################
	# 시작 => 나의__회원_레벨
	#########################################################

	//=======================================================
	// 나의__회원_번호
	$mb_mem_mn = $member['mb_no'];


	//=======================================================
	// 나의__회원_아이디
	$mb_id = $member['mb_id'];


	//=======================================================
	// 나의__회원_별명
	$mb_nick = $member['mb_nick'];


	//=======================================================
	// 출석체크__선택사항
	$select_n = 0;


	//=======================================================
	// 오늘_날짜
	$today_time_n = date("Ymd");


	//=======================================================
	// 오늘
	$date_s = date("Y-m-d");


	//=======================================================
	// 어제_날자
	$yester_date_n = date("Ymd", (G5_SERVER_TIME-86400));


	//=======================================================
	// 한마디
	$cont_s = get_text($cont_s);
	$cont_s = addslashes($cont_s);

	#########################################################
	# 끝 => 나의__회원_레벨
	#########################################################



	#########################################################
	# 시작 => 이미_출석체크__했는지__확인
	#########################################################

	//=======================================================
	// 오늘__출석체크_했는지__확인하기
	$sql	 = "SELECT COUNT(*) AS exist FROM `".$piree_table['attend_list']."` ";
	$sql	.= "WHERE date_n=".$today_time_n." AND mb_id='".$mb_id."'";
	$row	 = sql_fetch($sql);
	$exist = (int)$row["exist"];


	//=======================================================
	// 시작 => 이미__출석_했으면
	IF ($exist > 0)
	{
		alert ("오늘 이미 출석체크 하셨습니다.", $go_url_s);	
		EXIT;
	}
	// 끝 => 이미__출석_했으면
	//=======================================================

	#########################################################
	# 끝 => 이미_출석체크__했는지__확인
	#########################################################



	#########################################################
	# 시작 => 연속__출석체크_날자수__파악하기
	#########################################################

	//=======================================================
	// 마지막__출석체크_날자
	$conti_n = 0;


	//=======================================================
	// 마지막__출석체크_날자__알아내기
	$sql		 = "SELECT conti_n FROM `".$piree_table['attend_list']."` ";
	$sql		.= "WHERE date_n=".$yester_date_n." AND mb_id='".$mb_id."'";
	$row		 = sql_fetch($sql);
	$conti_n = (int)$row["conti_n"];


	// 증가
	$conti_n++;

	#########################################################
	# 끝 => 연속__출석체크_날자수__파악하기
	#########################################################



	#########################################################
	# 시작 => 나의__출석체크_순서__파악하기
	#########################################################

	//=======================================================
	// 나의__출석체크_순서__파악하기
	$sql	 = "SELECT COUNT(*) AS total FROM `".$piree_table['attend_list']."` ";
	$sql	.= "WHERE date_n=".$today_time_n;
	$row	 = sql_fetch($sql);
	$seq_n = (int)$row["total"];


	//=======================================================
	// 나의__출석체크_순서__형변환__증가
	$seq_n = (int)$seq_n;
	$seq_n++;

	#########################################################
	# 끝 => 나의__출석체크_순서__파악하기
	#########################################################



	#########################################################
	# 시작 => 출석체크_ROW__저장하기
	#########################################################

	//=======================================================
	// 출석체크_ROW__저장하는__쿼리문
	$sql	= "INSERT INTO `".$piree_table['attend_list']."` SET ";
	$sql .= "date_n=".$today_time_n.", ";
	$sql .= "seq_n=".$seq_n.", ";
	$sql .= "mem_mn=".$mb_mem_mn.", ";
	$sql .= "mb_id='".$mb_id."', ";
	$sql .= "mb_nick='".$mb_nick."', ";
	$sql .= "conti_n=".$conti_n.", ";
	$sql .= "select_n=".$select_n.", ";
	$sql .= "cont_s='".$cont_s."', ";
	$sql .= "attend_ip='".$_SERVER["REMOTE_ADDR"]."', ";
	$sql .= "regi_time_n=".G5_SERVER_TIME;


	//=======================================================
	// 시작 => 수정하지__못했으면
	IF (!sql_query($sql))
	{

		// 메세지
		$msg_in_s = "출석체크 정보를 저장하지 못했습니다.";

		// 에러
		alert ($msg_in_s, $go_url_s);
		EXIT;

	}
	// 끝 => 수정하지__못했으면
	//=======================================================

	#########################################################
	# 끝 => 출석체크_ROW__저장하기
	#########################################################



	#########################################################
	# 시작 => 오늘_출석체크_인원_수__수정하기
	#########################################################

	//=======================================================
	// 임의숫자_골라내기
	// 1/8
	$random_n = round((double)microtime()*8);


	//=======================================================
	// 오늘_출석체크_인원_수_복사
	$today_attend_t = $seq_n;


	//=======================================================
	// 시작 => 1_8__이면
	IF ($random_n == 1)
	{

		//=====================================================
		// 오늘_출석체크_인원_수__파악하기
		$sql	 = "SELECT COUNT(*) AS seq_n FROM `".$piree_table['attend_list']."` ";
		$sql	.= "WHERE date_n=".$today_time_n;
		$row	 = sql_fetch($sql);


		//=====================================================
		// 오늘_출석체크_인원_수
		$today_attend_t = (int)$row["seq_n"];

	}
	// 끝 => 1_8__이면
	//=======================================================


	//=======================================================
	// 오늘_출석체크_인원_수__수정하는__쿼리
	$sql	= "UPDATE `".$piree_table['calendar']."` SET ";
	$sql .= "attend_t=".$today_attend_t." ";
	$sql .= "WHERE date_n=".$today_time_n;


	//=======================================================
	// 시작 => 수정하지__못했으면
	IF (!sql_query($sql))
	{

		// 메세지
		$msg_in_s = "출석체크 정보를 저장하지 못했습니다.";

		// 에러
		alert ($msg_in_s, $go_url_s);
		EXIT;

	}
	// 끝 => 수정하지__못했으면
	//=======================================================

	#########################################################
	# 끝 => 오늘_출석체크_인원_수__수정하기
	#########################################################



	#########################################################
	# 시작 => 포인트__지급
	#########################################################

		#######################################################
		# 시작 => 포인트__지급__공통변수
		#######################################################

		//=====================================================
		// 테이블
		$rel_table = "@".$piree_table['attend_list'];


		//=====================================================
		// 게시글_번호
		$po_rel_id = "admin";

		#######################################################
		# 끝 => 출석_포인트__지급
		#######################################################



		#######################################################
		# 시작 => 출석_포인트__지급
		#######################################################

		//=====================================================
		// 시작 => 출석_포인트__있으면
		IF ($attend_config["attend_point"] > 0)
		{

			//===================================================
			// 지급할_포인트
			$point_grant_n = $attend_config["attend_point"];


			//===================================================
			// 포인트_지급__사유
			$grant_title = $date_s." 출석";


			//===================================================
			// 동작
			$active_s = $grant_title;


			//===================================================
			// 시작 => 수정하기
			insert_point($mb_id, $point_grant_n, $grant_title, $point_grp_n, $po_rel_id, $active_s);

		}
		// 끝 => 출석_포인트__있으면
		//=====================================================

		#######################################################
		# 끝 => 출석_포인트__지급
		#######################################################



		#######################################################
		# 시작 => 1등_포인트__지급
		#######################################################

		//=====================================================
		// 시작 => 1등__이면
		IF ($seq_n == 1)
		{

			//===================================================
			// 지급할_포인트
			$point_grant_n = $attend_config["rank_1_point"];


			//===================================================
			// 시작 => 1등_포인트__있으면
			IF ($point_grant_n > 0)
			{

				//=================================================
				// 포인트_지급__사유
				$grant_title = $date_s." 출석 1등";


				//=================================================
				// 동작
				$active_s = $grant_title;


				//=================================================
				// 시작 => 수정하기
				insert_point($mb_id, $point_grant_n, $grant_title, $point_grp_n, $po_rel_id, $active_s);

			}
			// 끝 => 1등_포인트__있으면
			//===================================================

		}
		// 끝 => 1등__이면
		//=====================================================

		#######################################################
		# 끝 => 1등_포인트__지급
		#######################################################



		#######################################################
		# 시작 => 개근_포인트__지급
		#######################################################

		//=====================================================
		// 시작 => 개근_일수__있으면
		IF ($attend_config["regular_day_n"] > 0)
		{

			//===================================================
			// 시작 => 개근_이면
			IF ($conti_n%$attend_config["regular_day_n"] == 0)
			{

				//=================================================
				// 시작 => 개근_포인트__있으면
				IF ($attend_config["regular_point"] > 0)
				{

					//===============================================
					// 지급할_포인트
					$point_grant_n = $attend_config["regular_point"];


					//===============================================
					// 포인트_지급__사유
					$grant_title = "출석 개근 ".$attend_config["regular_day_n"]."일";


					//===============================================
					// 동작
					$active_s = $grant_title;


					//===============================================
					// 시작 => 수정하기
					insert_point($mb_id, $point_grant_n, $grant_title, $point_grp_n, $po_rel_id, $active_s);

				}
				// 끝 => 개근_이면
				//=================================================

			}
			// 끝 => 개근_포인트__있으면
			//===================================================

		}
		// 끝 => 개근_일수__있으면
		//=====================================================

		#######################################################
		# 끝 => 개근_포인트__지급
		#######################################################

	#########################################################
	# 끝 => 포인트__지급
	#########################################################



	#########################################################
	# 시작 => 페이지__이동
	#########################################################

	//=======================================================
	// 마지막_페이지
	$total_page = ceil($seq_n / $config["cf_page_rows"]);


	//=======================================================
	// 이동할_페이지
	$move_url = PIREE_FREE_ATTEND_CHECK_URL.'/';


	//=======================================================
	// 알림
	goto_url($move_url);
	EXIT;

	#########################################################
	# 끝 => 페이지__이동
	#########################################################


?>